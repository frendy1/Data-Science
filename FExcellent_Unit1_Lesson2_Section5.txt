/* What are the three longest trips on rainy days? */

SELECT DISTINCT 
	t.duration 
FROM 
	weather AS w 
JOIN 
	trips AS t ON w.zip = t.zip_code 
WHERE 
	precipitationin > 0 
ORDER BY 
	duration DESC 
limit 3;

/* Which station is full most often? */

WITH dock_status_CTE AS 
	(
	SELECT 
		station_id, 
		count(timestamp) AS timestamp_count 
	FROM 
		status
	WHERE 
		docks_available = 0 
	GROUP BY 
		station_id
	) 
SELECT 
	s.name, 
	d.timestamp_count 
FROM dock_status_CTE AS d 
LEFT JOIN 
	stations AS s ON d.station_id = s.station_id 
ORDER BY timestamp_count DESC;

/* Return a list of stations with a count of number of trips starting at that station but ordered by dock count. *

WITH start_trip_CTE AS 
	(
	SELECT 
		start_station, 
		count(trip_id) AS trip_count 
	FROM trips 
	GROUP BY start_station
	) 
SELECT 
	t.start_station, 
	s.dockcount, 
	t.trip_count 
FROM 
	start_trip_CTE AS t 
LEFT JOIN 
	stations AS s ON t.start_station = s.name 
ORDER BY dockcount;

/* (Challenge) What's the length of the longest trip for each day it rains anywhere?  */

WITH duration_max_CTE AS 
	(
	SELECT 
		start_date::timestamp::date AS biking_date, 
		max(duration) AS duration_max 
	FROM trips 
	GROUP BY biking_date
	), 
	find_rainy_day_CTE AS 
	(
	SELECT 
		date::timestamp::date AS rainy_date, 
		precipitationin
	FROM weather
	) 
SELECT DISTINCT 
	w.rainy_date, 
	d.duration_max
FROM find_rainy_day_CTE AS w 
LEFT JOIN 
	duration_max_CTE AS d ON rainy_date = d.biking_date 
WHERE precipitationin > 0 
ORDER BY duration_max DESC;